export const metadata = {
  title: 'API Authentication',
  description:
    'Learn how to authenticate with the Tiro.health API using OAuth2 client credentials flow for secure machine-to-machine communication.',
}

export const sections = [
  { title: 'Overview', id: 'overview' },
  { title: 'Authentication Flow', id: 'authentication-flow' },
  { title: 'Obtain Client Credentials', id: 'obtain-client-credentials' },
  { title: 'Request Access Token', id: 'request-access-token' },
  { title: 'Use Access Token', id: 'use-access-token' },
  { title: 'Token Expiration', id: 'token-expiration' },
  { title: 'Security Best Practices', id: 'security-best-practices' },
]

# API Authentication

Authenticate your API requests to Tiro.health using OAuth2 client credentials flow for secure machine-to-machine communication. {{ className: 'lead' }}

---

## Overview

The Tiro.health Capture API uses **OAuth2 client credentials flow** for authentication. This is the standard approach for server-to-server communication where your application needs to access the API on behalf of itself, not a specific user.

### When to Use OAuth2 Client Credentials

Use OAuth2 client credentials authentication when you need to:

- **Create sessions** programmatically via the [Session Management API](/api/session-management)
- **Access FHIR resources** for data import and export
- **Integrate with EHR/LIS systems** in the background without user interaction
- **Automate workflows** that interact with Tiro.health programmatically

### Key Benefits

- **Secure**: Client credentials are never exposed in URLs or browser contexts
- **Standard**: Follows OAuth2 RFC 6749 specifications
- **Token-based**: Access tokens can be cached and reused until expiration
- **Flexible**: Works with any HTTP client or programming language

---

## Authentication Flow

The OAuth2 client credentials flow follows this sequence:

```mermaid
sequenceDiagram
    participant App as Your Application
    participant Auth as Tiro.health<br/>Auth Server
    participant API as Tiro.health<br/>API

    App->>Auth: POST /oauth/token<br/>(client credentials)
    Auth-->>App: Access Token
    App->>API: API Request<br/>(Bearer Token)
    API-->>App: API Response
```

1. **Obtain credentials**: Get your `client_id` and `client_secret` from Tiro.health
2. **Request token**: Exchange credentials for an access token at the token endpoint
3. **Use token**: Include the access token in the `Authorization` header of API requests
4. **Refresh when expired**: Request a new token when the current one expires

---

## Obtain Client Credentials

Before you can authenticate, you need to obtain OAuth2 client credentials from Tiro.health:

1. Contact your Tiro.health account manager or support team
2. Provide information about your integration:
   - Organization name
   - Integration purpose (e.g., EHR integration, data import)
   - Expected API usage
3. Receive your credentials:
   - `client_id` - Your application's unique identifier
   - `client_secret` - Your application's secret key (keep this secure!)

**Important**: Store your `client_secret` securely. Never commit it to version control or expose it in client-side code.

---

## Request Access Token {{ tag: 'POST', label: '/oauth/token' }}

<Row>
  <Col>

Exchange your client credentials for an access token by making a POST request to the token endpoint.

### Request Parameters

<Properties>
  <Property name="grant_type" type="string" required>
    Must be `"client_credentials"` for machine-to-machine authentication.
  </Property>
  <Property name="client_id" type="string" required>
    Your application's client identifier provided by Tiro.health.
  </Property>
  <Property name="client_secret" type="string" required>
    Your application's secret key provided by Tiro.health.
  </Property>
</Properties>

### Response Fields

<Properties>
  <Property name="access_token" type="string">
    The access token to use for authenticated API requests.
  </Property>
  <Property name="token_type" type="string">
    Always `"Bearer"` - indicates the token should be used in the Authorization header.
  </Property>
  <Property name="expires_in" type="integer">
    Number of seconds until the token expires (typically 3600 = 1 hour).
  </Property>
</Properties>

  </Col>
  <Col sticky>

    <CodeGroup title="Request Access Token">

    ```bash {{ title: 'cURL' }}
    curl -X POST https://auth.tiro.health/oauth/token \
      -H "Content-Type: application/x-www-form-urlencoded" \
      -d "grant_type=client_credentials" \
      -d "client_id=your_client_id" \
      -d "client_secret=your_client_secret"
    ```

    ```csharp {{ title: 'C#' }}
    using System.Net.Http;
    using System.Text.Json;

    var client = new HttpClient();
    var content = new FormUrlEncodedContent(new[]
    {
        new KeyValuePair<string, string>("grant_type", "client_credentials"),
        new KeyValuePair<string, string>("client_id", "your_client_id"),
        new KeyValuePair<string, string>("client_secret", "your_client_secret")
    });

    var response = await client.PostAsync(
        "https://auth.tiro.health/oauth/token",
        content
    );

    var tokenResponse = await response.Content.ReadFromJsonAsync<TokenResponse>();
    string accessToken = tokenResponse.AccessToken;
    ```

    ```javascript {{ title: 'JavaScript' }}
    const response = await fetch('https://auth.tiro.health/oauth/token', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: new URLSearchParams({
        grant_type: 'client_credentials',
        client_id: 'your_client_id',
        client_secret: 'your_client_secret',
      }),
    });

    const data = await response.json();
    const accessToken = data.access_token;
    ```

    ```python {{ title: 'Python' }}
    import requests

    response = requests.post(
        'https://auth.tiro.health/oauth/token',
        data={
            'grant_type': 'client_credentials',
            'client_id': 'your_client_id',
            'client_secret': 'your_client_secret',
        }
    )

    token_data = response.json()
    access_token = token_data['access_token']
    ```

    </CodeGroup>

    ```json {{ title: 'Response (200 OK)' }}
    {
      "access_token": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...",
      "token_type": "Bearer",
      "expires_in": 3600
    }
    ```

  </Col>
</Row>

---

## Use Access Token

Once you have an access token, include it in the `Authorization` header of your API requests using the `Bearer` scheme.

### Authorization Header Format

```
Authorization: Bearer <access_token>
```

The token grants you access to all Tiro.health API endpoints based on your client's permissions, including:

- **Session Management API** - Create and manage user sessions
- **FHIR API** - Access patient data, questionnaires, and responses
- **Task API** - Create and manage tasks for users

<Row>
  <Col>

### Example: Using the Token

Include the Bearer token in the Authorization header of your requests.

  </Col>
  <Col sticky>

    <CodeGroup title="Example API Request with Token">

    ```bash {{ title: 'cURL' }}
    curl https://reports.tiro.health/session \
      -H "Authorization: Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9..." \
      -H "Content-Type: application/json" \
      -d '{
        "scope": "patient/Patient.read",
        "patient": 123
      }'
    ```

    ```csharp {{ title: 'C#' }}
    var client = new HttpClient();
    client.DefaultRequestHeaders.Authorization =
        new AuthenticationHeaderValue("Bearer", accessToken);

    var payload = new {
        scope = "patient/Patient.read",
        patient = 123
    };

    var response = await client.PostAsJsonAsync(
        "https://reports.tiro.health/session",
        payload
    );
    ```

    ```javascript {{ title: 'JavaScript' }}
    const response = await fetch('https://reports.tiro.health/session', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        scope: 'patient/Patient.read',
        patient: 123,
      }),
    });
    ```

    ```python {{ title: 'Python' }}
    import requests

    headers = {
        'Authorization': f'Bearer {access_token}',
        'Content-Type': 'application/json',
    }

    payload = {
        'scope': 'patient/Patient.read',
        'patient': 123,
    }

    response = requests.post(
        'https://reports.tiro.health/session',
        headers=headers,
        json=payload
    )
    ```

    </CodeGroup>

  </Col>
</Row>

---

## Token Expiration

Access tokens are temporary and expire after a set period (typically 1 hour).

### Handling Token Expiration

When a token expires, API requests will return a `401 Unauthorized` error:

```json
{
  "error": "invalid_token",
  "error_description": "The access token expired"
}
```

**Recommended approach:**

1. **Cache the token** - Store the access token and its expiration time
2. **Check expiration** - Before making API requests, verify the token hasn't expired
3. **Request new token** - When expired, request a new token using your client credentials
4. **Retry request** - Retry the failed API request with the new token

### Example: Token Management

<CodeGroup title="Token Caching and Refresh">

```csharp {{ title: 'C#' }}
public class TokenManager
{
    private string _accessToken;
    private DateTime _expiresAt;
    private readonly HttpClient _client = new HttpClient();

    public async Task<string> GetValidTokenAsync()
    {
        if (DateTime.UtcNow >= _expiresAt)
        {
            await RefreshTokenAsync();
        }
        return _accessToken;
    }

    private async Task RefreshTokenAsync()
    {
        var content = new FormUrlEncodedContent(new[]
        {
            new KeyValuePair<string, string>("grant_type", "client_credentials"),
            new KeyValuePair<string, string>("client_id", "your_client_id"),
            new KeyValuePair<string, string>("client_secret", "your_client_secret")
        });

        var response = await _client.PostAsync(
            "https://auth.tiro.health/oauth/token",
            content
        );

        var tokenData = await response.Content.ReadFromJsonAsync<TokenResponse>();
        _accessToken = tokenData.AccessToken;
        _expiresAt = DateTime.UtcNow.AddSeconds(tokenData.ExpiresIn - 60); // 60s buffer
    }
}
```

```javascript {{ title: 'JavaScript' }}
class TokenManager {
  constructor(clientId, clientSecret) {
    this.clientId = clientId;
    this.clientSecret = clientSecret;
    this.accessToken = null;
    this.expiresAt = null;
  }

  async getValidToken() {
    if (!this.accessToken || Date.now() >= this.expiresAt) {
      await this.refreshToken();
    }
    return this.accessToken;
  }

  async refreshToken() {
    const response = await fetch('https://auth.tiro.health/oauth/token', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({
        grant_type: 'client_credentials',
        client_id: this.clientId,
        client_secret: this.clientSecret,
      }),
    });

    const data = await response.json();
    this.accessToken = data.access_token;
    // Subtract 60 seconds as buffer
    this.expiresAt = Date.now() + (data.expires_in - 60) * 1000;
  }
}
```

```python {{ title: 'Python' }}
import requests
from datetime import datetime, timedelta

class TokenManager:
    def __init__(self, client_id, client_secret):
        self.client_id = client_id
        self.client_secret = client_secret
        self.access_token = None
        self.expires_at = None

    def get_valid_token(self):
        if not self.access_token or datetime.now() >= self.expires_at:
            self.refresh_token()
        return self.access_token

    def refresh_token(self):
        response = requests.post(
            'https://auth.tiro.health/oauth/token',
            data={
                'grant_type': 'client_credentials',
                'client_id': self.client_id,
                'client_secret': self.client_secret,
            }
        )

        token_data = response.json()
        self.access_token = token_data['access_token']
        # Subtract 60 seconds as buffer
        expires_in = token_data['expires_in'] - 60
        self.expires_at = datetime.now() + timedelta(seconds=expires_in)
```

</CodeGroup>

---

## Security Best Practices

### Protect Your Client Credentials

- **Never commit** `client_secret` to version control (use environment variables or secret management)
- **Never expose** credentials in client-side code or public repositories
- **Use HTTPS only** - Always use encrypted connections when transmitting credentials
- **Rotate regularly** - Change your credentials periodically or if compromised

### Secure Token Storage

- **Server-side only** - Never send access tokens to client browsers or mobile apps
- **Memory storage** - Store tokens in memory rather than persistent storage when possible
- **Encrypt at rest** - If you must persist tokens, encrypt them
- **Clear on logout** - Dispose of tokens properly when no longer needed

### API Request Security

- **HTTPS only** - All API requests must use HTTPS
- **Validate responses** - Check for authentication errors and handle them appropriately
- **Rate limiting** - Implement backoff strategies for rate-limited responses
- **Minimal permissions** - Request only the access your application needs

### Monitoring and Auditing

- **Log access** - Keep audit logs of API access (but never log tokens or credentials)
- **Monitor usage** - Track API usage patterns to detect anomalies
- **Alert on failures** - Set up alerts for repeated authentication failures
- **Review regularly** - Periodically review client access and permissions

---

## Next Steps

Now that you understand OAuth2 authentication, you can:

- **[Create sessions](/api/session-management)** - Use the Session Management API to create authenticated user sessions
- **[Access FHIR resources](/fhir)** - Query and modify patient data via the FHIR API
- **[Import data](/api)** - Set up background data synchronization with your EHR/LIS

For alternative authentication methods, see:

- **[FHIR API Authentication](/fhir/authentication)** - Basic authentication and user identification
- **[SMART on FHIR](/smart-on-fhir)** - User-delegated access with context launch
